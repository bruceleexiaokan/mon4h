<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="pragma" content="no-cache" />
<meta http-equiv="Cache-Control" content="no-cache, must-revalidate" />
<meta http-equiv="expires" content="#REQUEST_TIME_NOW" />
<meta http-equiv="content-type" content="text/html; charset=UTF-8" />
<!-- <meta http-equiv="x-ua-compatible" content="ie=10"/> -->
<style>
* {
	font-family:'Microsoft Yahei';
}
#naviagtor,#dashboardDemo {
	font-size:14px;
}

#logo {
	padding: 10px 5px;
	background-color: #292929;
	color: #eee;
	overflow: hidden;
	float: right;
	font-size: 18px;
}

.header {
	margin: 0;
	padding: 10px 5px;
	background-color: #292929;
	color: #eee;
	overflow: hidden;
	width: 99%;
}

.logo {
	float: right;
	font-size: 15px;
}

#naviagtor {
	margin: 0;
	padding: 10px 5px;
	list-style: none;

	border: 1px solid gray;
	overflow: hidden;
	zoom: 1;
}
#navigator2 {
	margin:0;
	padding:10px 5px;
	list-style:none;
	width:99%;
	border:1px solid gray;
	overflow:hidden;
	zoom:1;
}
#navigator3 {
	margin:0;
	padding:10px 5px;
	list-style:none;
	width:99%;
	border:1px solid gray;
	overflow:hidden;
	zoom:1;
}
#navigator4 {
	margin:0;
	padding:10px 5px;
	list-style:none;
	width:99%;
	border:1px solid gray;
	overflow:hidden;
	zoom:1;
}
#matricNameTips {
	position: absolute;
	width: 880px;
	background: #FFF;
	border: 1px solid #aac8ff;
	margin: 0;
	padding: 0;
	overflow: hidden;
	z-index: 4;
}

#matricNameTips li {
	margin:-1px 0 0 0;
	padding:0;
	overflow:hidden;
}
#matricNameTips a {
	display:block;
	padding:5px;
	color:#369;
	text-decoration:none;
	border-top:1px solid #FFF;
	border-bottom:1px solid #FFF;
}
#matricNameTips a:hover {
	border-top:1px solid #aac8ff;
	border-bottom:1px solid #aac8ff;
	background:#d9e6ff;
}
#matricNameTips span {
	padding:5px;
}

#naviagtor li {
	float: left;
	margin-right: 3px;
}
#naviagtor a {
	color:#0066ff;
	margin-left:10px;
}
#dashboardDemo {
	margin-top: 5px;
}
</style>
<link rel="shortcut icon" href="../favicon.ico" />
<title>Dashboard</title>

<script type="text/javascript" src="../cQuery_110421.js"></script>
<script type="text/javascript" src="../jquery-1.8.3.js"></script>
<script type="text/javascript" src="../dashboard.js"></script>
<script type="text/javascript" src="../calendar.js"></script>
#this_html_script_content_template

<!--  <link rel="stylesheet" href="http://192.168.63.39:4242/s/gwt/standard/standard.css"> -->
 </head>
<body>
<div class="header" id = "head">
		<h1 class="logo">Dashboard Common UI </h1>
		</div>
		
		<div id="navigator2">

		Metric NameSpace:&nbsp; <input id="matricNamespace" type="text"
			style="position: relative; z-index: 210; background: transparent;"
			value="" /> &nbsp; Metric Name:&nbsp;
		<ul id="matricNameTips" style="display: none;"></ul>
		<input id="matricNameGray" type="text"
			style="position: absolute; z-index: 200; color: gray; width: 380px"
			value="" /> <input id="matricName" type="text"
			style="position: relative; z-index: 210; background: transparent; width: 380px"
			value="" />
	</div>
	<div id="navigator3" style="display: none;" float=left></div>
	<div id="navigator4" style="display: none;" float=left>
		<div style="float: left;">
			开始时间:&nbsp <input id="time_start" type="text" size="21"
				maxlength="19" onclick="calendar.show(this);" />
		</div>
		<div style="float: left;">
			结束时间: &nbsp <input id="time_end" type="text" size="21" maxlength="19"
				onclick="calendar.show(this);" />
		</div>
		<div style="float: left;">
			时间间隔: &nbsp <input id="time_inter" type="text" size="11"
				maxlength="10" />
		</div>
		<div style="float: left;">
			图标类型:&nbsp <select id="select_style">

				<option value="line">静态线图</option>
				<option value="realtime">实时线图</option>
				<option value="pie">饼图</option>
				<option value="stock">柱状图</option>
			</select>
		</div>
		<div style="float: left;">
			聚类方式: &nbsp <select id="select_aggre">
				<option value="sum">sum</option>
				<option value="min">min</option>
				<option value="max">max</option>
				<option value="avg">avg</option>
				<option value="dev">dev</option>
			</select>
		</div>
		<div style="float: left;">
			采样方式: &nbsp <select id="select_downsample">
				<option value="sum">sum</option>
				<option value="min">min</option>
				<option value="max">max</option>
				<option value="avg">avg</option>
				<option value="dev">dev</option>
			</select>
		</div>
		<div style="float: left;">
			变化量: &nbsp <input type="checkbox" id="is_rate" /> &nbsp;
		</div>
		<div style="float: left;">
			<input type=button value="查询" id="find_the_new" />&nbsp;
		</div>
		<div style="float: left;">
			<input type=button value="生成分享URL" id="load_url" />&nbsp;
		</div>
	</div>
	<div class="dashboard" id="dashboardDemoRealtime" style="display: none"></div>
	<div id="dashboardDemo">

		<div class="dashboard" id="dashboardDemoAppID" style="display: none"></div>
		<div class="dashboard" id="dashboardDemoHostName"
			style="display: none"></div>
		<div class="dashboard" id="dashboardDemoLevel" style="display: none"></div>
		<div class="dashboard" id="dashboardDemoInfo" style="display: none"></div>
	</div>

<script>
#this_html_is_show_content_template

if( navigator.userAgent.indexOf("MSIE")>0)
	alert("不建议使用IE浏览器。容易出现显示问题  ");
	
	
var timeoff		 = -3;
var endTime 	 = (new Date()).addMinutes(timeoff);
var startTime	 = endTime.addHours(-1);
var timeInterval = '1m';
var matricPanel  = $('#navigator2');
var tagPanel 	 = $('#navigator3');
var StagPanel 	 = $('#navigator4');

var clock,lastMatricNameVal;
var requestCount=0;
var getMatricsURL='[[query_engine_server/]/]/jsonp/getmetricstags?reqdata=${reqdata}&callback=${callback}';
var matricName=$('#matricName');
var matricNameFlag=0;
var matricNameGray=$('#matricNameGray');
var matricNameTips=$('#matricNameTips');
var namespace=$('#matricNamespace');
var chartStyle =$('#select_style');
var head = $('#head');
var onlyOnce = 0 ;
var splitCharA = '&';
var splitCharB = '=';
var tag_conf={};
var Stag_conf={};

tag_conf['startTime']=$('#time_start');
tag_conf['endTime']=$('#time_end');
tag_conf['interval']=$('#time_inter');
tag_conf['chart']=$('#select_style');
tag_conf['statistics']=$('#select_aggre');
tag_conf['downfunc']=$('#select_downsample');
tag_conf['rate']	  = $('#is_rate');

var newConfig={
	title: matricName.value(),
	panel:$('#dashboardDemoAppID'),
	bases:{
		'%chart%':		'line',
		'%startTime%':	startTime.format(calendar.date2StringPattern),
		'%endTime%':	endTime.format(calendar.date2StringPattern),
		'%interval%':	timeInterval,
		'%metric%':		matricName.value(),
		'%rate%':		'false',	
		statistics:		'sum',
		downfunc:		'sum'
	},
	exps:{
	},
	groups:[]
}; 
var defaultConfig={
		'%chart%':		'line',
		'%startTime%':	startTime.format(calendar.date2StringPattern),
		'%endTime%':	endTime.format(calendar.date2StringPattern),
		'%interval%':	timeInterval,
		'%metric%':		matricName.value(),
		'%rate%':		'false',	
		statistics:		'sum',
		downfunc:		'sum'
}
var lastConfig={
}; 

var tags; 
var lastV = [] ;

var de_rate = 'false';
 
var currentTab=-999;
var realtimePanel=$('#dashboardDemoRealtime');
var realtimeRef=null;
var orPanel=$('#dashboardDemoAppID');

var countUL = 0;


$('#load_url').bind('click',show_url);

matricNameTips.offset(matricName);
matricName.bind('focus',matricNameFocusEvent);
matricName.bind('blur',matricNameBlurEvent);
chartStyle.bind('change', chartC);
var AppId='';
if( [[trace_log_need_check/]/] == 1 ) {
	AppId='-';
}

var jumpUrl='[[logview_logging_server/]/]/search?appId=' + AppId + '${AppID}&dateFrom=${dateFrom}&dateTo=${dateTo}&host=${HostName}&logType=ALL&logTitle=${Title}&logLevelAbove=logLevelAbove';
var find_the_new=$('#find_the_new');
find_the_new.bind('click',function(){
	if(CheckFunction()){
		showTable2();
	}
});


var flag = '';  // the first bit stands for image ; the second one for custom ; 
				//the third one for shared-URL; the more requirements, the more bits 
var paraString = '';
var long_url = window.location.href;
if(long_url.indexOf('#uid') != -1){
	long_url = long_url.substring(0,long_url.indexOf('#uid'));
}


if(long_url.indexOf('?')==-1){
	flag = '';
}
else{
	 paraString = long_url.substring(long_url.indexOf("?")+1,long_url.length);
	var loc = paraString.indexOf('reqdata');
	flag = paraString.substring(5,loc-1);
	paraString = paraString.substring(loc+8,paraString.length);
}


var url = "";
//var theRequest = new Object();
var show = false;
					 
var image  = (flag.indexOf('image') != -1);
var custom = false;
var shared = false;
if(typeof(is_show) != 'undefined'){
	
	custom = is_show ;
}
if(paraString != ''){
	shared = true;	
}

if(image){
	custom = false;
	shared = false;
}


if(custom){
	shared = false;
	if(typeof(content) != 'undefined'){
		url = content;	}
	else{
		alert("html_301, no content but you need me show~~~");}
	show = true;
	var strs = url.split(splitCharA);  
	for(var i = 0; i < strs.length; i ++){   
		var key = strs[i].split(splitCharB)[0];
		var value = strs[i].split(splitCharB)[1];
		if(key == 'metric'){
			newConfig.bases['%metric%'] = value;
			newConfig.title = value;
			meticNameForShow = value;
			matricName.value(value);
		}
		else if(key == 'startTime'){
			newConfig.bases['%startTime%'] = value;
		}
		else if(key == 'endTime'){
			newConfig.bases['%endTime%']   = value;
		}
		else if(key == 'interval'){
			newConfig.bases['%interval%']  = value;
		}
		else if(key == 'rate'){
			newConfig.bases['%rate%'] = value;
			if(value){
				document.getElementById("is_rate").checked = true ;
			}
		}
		else if(key == 'namespace'){
			newConfig.namespace = value;
			$('#matricNamespace').value(value);
		}
		else if(key == 'statistics'){
			newConfig.bases['statistics'] = value;
		}
		
		else if(key == 'downfunc'){
			newConfig.bases['downfunc'] = value;
		}
		else if(key == 'chart'){
			newConfig.bases['%chart%'] = value;
			//alert(value);
		}
		else{
			if(value== '*'){
				newConfig.bases['@'+key+'@'] = '*';
				$('#'+key).value('*');
			}
			else if(value == ''){
				$('#'+key).value('');
			}
			
			else{
				newConfig.bases['@'+key+'@'] = value.split(',').trim();
				$('#'+key).value(value);
			}
			newConfig.groups.push(key);
		}
	}
	$('#time_start').value(newConfig.bases['%startTime%']);
	$('#time_end').value(newConfig.bases['%endTime%']);
	$('#time_inter').value(newConfig.bases['%interval%']);
	$('#select_style').value(newConfig.bases['%chart%']);
	$('#select_aggre').value(newConfig.bases['statistics']);
	$('#select_downsample').value(newConfig.bases['downfunc']);
	
	StagPanel.css('display','');
	tagPanel.css('display','none');
	matricPanel.css('display','none');
      
	showTable2();	

}
if(shared){
	sharedFunc();
}

if(image){
	
	sharedFunc();
	window.onload = function(){
	setTimeout(function(){
		find_the_new['click']();
		head.css('display','none');
		tagPanel.css('display','none');
		matricPanel.css('display','none');
		StagPanel.css('display','none');
	},300);
	};
}

function sharedFunc(){
	matricPanel.css('display','');
	if(paraString != long_url){
		StagPanel.css('display','');
		tagPanel.css('display','');
		var final_url = unescape(paraString);
		parse_url(final_url);	
	}
}




function chartC(){	
	if(chartStyle.value() == 'line'){
		var tEndTime 	 = (new Date()).addMinutes(timeoff);
		var tStartTime	 = tEndTime.addHours(-1);

		$('#time_start').value(tStartTime.format(calendar.date2StringPattern));
		$('#time_end').value(tEndTime.format(calendar.date2StringPattern));		
	}
}


function showTable2(){
	if (newConfig.ref){
		newConfig.ref.uninit();
	}     
	lastConfig=$.copy($.extend(true,{},newConfig));
	newConfig.ref=newConfig.panel.regMod('dashboard','1.0',lastConfig);	
	orPanel.css('display','');  
}


function show_url(){
	var URL_host = '[[export_svg_server/]/]/dashboard-ui/common/dashboard.html';
	var url_show= '?flag=0010&reqdata=';
	var temp = '';	
	
	for(var key in newConfig.bases){
		temp += splitCharA+key+splitCharB+newConfig.bases[key].toString(); 
	}
	temp += splitCharA+'groups'+splitCharB+ newConfig.groups.join("-");
	temp += splitCharA+'namespace'+splitCharB + namespace.value();
	temp = escape(temp);
	url_show += temp;
	window.open(URL_host+url_show);
}

function parse_url(url) {
	var anewConfig={
		title: matricName.value(),
		panel:$('#dashboardDemoAppID'),
		bases:{
			'%chart%':		'line',
			'%startTime%':	startTime,
			'%endTime%':	endTime,
			'%interval%':	timeInterval,
			'%metric%':		matricName.value(),
			'%rate%':		'false',	
			statistics:		'sum',
			downfunc:		'sum'
		},
		exps:{
		},
		groups:[]
	};

	var strs = url.split(splitCharA);   
	for(var i = 1; i < strs.length; i ++){   
		var key = strs[i].split(splitCharB)[0];
		var value = (strs[i].split(splitCharB)[1]);
		if(key == 'namespace'){
			anewConfig.namespace = value;
		}
		else if(key == 'groups'){
			value=value.split('-');
			anewConfig.groups = value;
		}
		else{
			anewConfig.bases[key] = value;
		}
	}
	namespace.value(anewConfig.namespace);
	matricName.value(anewConfig.bases['%metric%']);

	for (var key in Stag_conf){           
		if (Stag_conf.hasOwnProperty(key)){			
			delete newConfig.bases['@'+key+'@']; 
				
		}
	}
	newConfig.groups=[];
	
	var uid='dashboard_loadTags_'+$.uid();
	var done=0;
	
	$.tmp[uid]=function(t){ 
		done=1;	
		t=t['time-series-list']; 
		var i = 0 ;
	
		tags=t[0]['tags'];
		var divtest=$('#navigator3');			
		Stag_conf={};
		divtest.html($.tmpl.render('{{each $data}}<div style="float:left;"><label><span style="display:inline-block;width:100px;text-align:right;white-space:nowrap; word-break:keep-all;overflow:hidden; text-overflow:ellipsis; vertical-align: middle" title="${$value}">${$value}</span>: <input id="tag${$index}" name="${$value}" value="" /> </label></div> {{/each}}',tags));
		
		var index = 0;
		tags.each(function(tag){
			Stag_conf[""+tag+""]=$('#tag'+index);
			index++;
		});
		for(var key in anewConfig.bases){
			if(key[0] == '@'){
				if(anewConfig.bases[key] == ''){
					//$('#'+key.substring(1,key.length-1)).value('*');
					Stag_conf[key.substring(1,key.length-1)].value('*');			
				}
				else{
					Stag_conf[key.substring(1,key.length-1)].value( anewConfig.bases[key]);
				}
			}
		}
	}
	
	var namespaceValue=namespace.value();
	if( namespaceValue=="" ) {
		namespaceValue = null;
	}
	
	var reqTagData={
	"version":1,
	"time-series-pattern":{
			"namespace":namespaceValue,
			"metrics-name":{
				"start-with":matricName.value()
			}
		}
	}
    
	var tagurl=$.tmpl.render(getMatricsURL,{
		reqdata:encodeURIComponent($.stringifyJSON(reqTagData)),
		callback:encodeURIComponent('cQuery.tmp["'+uid+'"]')
	});
	var evt=function(){
		if (!done){
			if(onlyOnce ==0){
				alert('Loading tags error, error server response. html 504');
				onlyOnce = 1;
			}
		}else{
			onlyOnce = 0;
			delete cQuery.tmp[uid];
	}
	};
	$.loader.js(tagurl,{
		async:true,
		charset:'utf-8',
		onload:evt,
		onerror:evt});
		
	newConfig.bases['%metric%']=matricName.value(); 	
	tagPanel.css('display','');
	StagPanel.css('display','');
	
	for (var key in tag_conf){
		if (tag_conf.hasOwnProperty(key)){
			tag_conf[key].value('');
		}
	};

	for(var key in anewConfig.bases){
		var key2;
		if(key != 'statistics' && key !='downfunc'){
			key2 = key.substring(1,key.length-1);
		}else{
			key2 = key;
		}	

		if(typeof(tag_conf[key2]) != 'undefined'){
			if(key == '%rate%'){
				if(anewConfig.bases[key].toString()=="true")
					document.getElementById("is_rate").checked = true ;
				else
					document.getElementById("is_rate").checked = false ;
			}
			else
				tag_conf[key2].value(anewConfig.bases[key].toString());
		}
	}

}

function matricNameFocusEvent(){
	matricNameFlag=1;
	checkInput();
	clock=setInterval(checkInput,200);
}

function matricNameBlurEvent(){
	matricNameFlag=0;
	lastMatricNameVal=null;
	clearInterval(clock);
	checkInput();
	matricNameGray.value('');
	matricNameTips.css('display','none');
}

function checkInput(){
	var val=matricName.value();
	if (lastMatricNameVal===val){
		return false;
	}
	onlyOnce = 0;
	lastMatricNameVal=val;
	if (val==''){
		matricNameGray.value('');
		matricNameTips.css('display','none');
	}else{
		//matricNameGray.value('');
		loadMatrics(val,function(matrics){
			if (!matricNameFlag){
				return false;
			}
			if (matrics._count){
				var t=[];
				for (var i=0,n=matrics._list.length;i<n;i++){
					t.push('<li><a href="###">'+matrics._list[i]+'</a></li>');
				}
				t=t.join('');
			}else{
				t='<li><span>None Matric start with '+val+'</span></li>';
			}
			matricNameGray.value(matrics._start);
			matricNameTips.html(t);
			matricNameTips.css('display','');
		});
	}
}

function getRequestCount(){
	return ++requestCount;
}

function isCurrentRequest(t){
	return requestCount==t;
}

function loadMatrics(val,callback){             
	var uid='dashboard_loadTags_'+$.uid();
	var done=0;
	var reqUid=getRequestCount();
	$.tmp[uid]=function(t){      
		done=1;
		if (!isCurrentRequest(reqUid)){   
			return;
		}
		if ($.type(t)!=='object'||t['result-code']!==0){
			$.error('dashboard._loadTags','Found error: '+$.stringifyJSON(t));
			return;
		}
	
		t=t['time-series-list'];         
		
		var ret={
			_list:[],
			_start:'',
			_count:t.length
		};
		for (var i=0,n=t.length;i<n;i++){
			var matric=t[i]['metrics-name'];
			var tags=t[i]['tags'];
			ret[matric]=tags;
			ret._list.push(matric);
		}
		t=ret._list.join('\n')+'\n';
		var arr=t.match(new RegExp('^(.+).*\\n(?:\\1.*\\n){'+(ret._count-1)+'}$'));
		if (arr){
			ret._start=arr[1];
		}
		callback&&callback(ret);
	};
	
	var namespaceValue=namespace.value();
	if( namespaceValue=="" ) {
		namespaceValue = null;
	}
	
	var reqData={
		"version":1,
		"time-series-pattern":{
			"namespace":namespaceValue,
			"metrics-name":{
				"start-with":val
			}
		}
	};
	
	var url=$.tmpl.render(getMatricsURL,{
		reqdata:encodeURIComponent($.stringifyJSON(reqData)),
		callback:encodeURIComponent('cQuery.tmp["'+uid+'"]')
	});
	var evt=function(){
		if (!done){
			if(onlyOnce ==0){
				onlyOnce = 1;
				alert('Loading tags error, error server response. html 415');
			}
		}else{
			onlyOnce = 0;
			delete cQuery.tmp[uid];
		}
	};
	$.loader.js(url,{
		async:true,
		charset:'utf-8',
		onload:evt,
		onerror:evt
	});

}

matricName.bind('keydown',function(e){
	if (e.keyCode==9){                    //  key Tab
		matricName.value(matricNameGray.value());	
		e.stop();
		return false;
	}
	if (e.keyCode==13){
		//matricName[0].blur();
	
		matricName.value($(matricNameTips.find("li")[0]).text());
		doTipClick($(matricNameTips.find("li")[0]).text());
		e.stop();
		return false;
	}
	

	
});



matricNameTips.bind('mousedown', tipClick);

function doTipClick(name){
	
	orPanel.css('display','none'); 
	realtimePanel.css('display','none');

	matricName.value(name);
		
		for (var key in Stag_conf){            //the tags from Stag_conf (newconfig.exps) can be changed to null or selected as the groupby tag, so  
			if (Stag_conf.hasOwnProperty(key)){			
				delete newConfig.bases['@'+key+'@']; //delete the tag	
					
			}
		}
		newConfig.groups=[];
		
		var uid='dashboard_loadTags_'+$.uid();
		
		namespaceValue = namespace.value();
		var done=0;
		
		$.tmp[uid]=function(t){ 
			done=1;
			
			//alert("matricNameTips");
			
			t=t['time-series-list'];  
			var i = 0;
			for(;i< t.length ;i++){
				if(t[i]['metrics-name'] == newConfig.bases['%metric%']){
					break;
					}
			}
			
			tags=t[i]['tags'];
			var divtest=$('#navigator3');			
			Stag_conf={};
			divtest.html($.tmpl.render('{{each $data}}<div style="float:left;"><label><span style="display:inline-block;width:100px;text-align:right;white-space:nowrap; word-break:keep-all;overflow:hidden; text-overflow:ellipsis; vertical-align: middle" title="${$value}">${$value}</span>: <input id="tag${$index}" name="${$value}" value="" /> </label></div> {{/each}}',tags));
		
		var index = 0;
			tags.each(function(tag){
				
				Stag_conf[""+tag+""]=$('#tag'+index);
				index++;
			});
		
		}
		

		if( typeof(namespaceValue) == 'undefined' ){
			namespaceValue = null;
		}else{
			if(namespaceValue=="" ) {
		
				namespaceValue = null;
			}
		}
		var reqTagData={
		"version":1,
		"time-series-pattern":{
			"namespace":namespaceValue,
			"metrics-name":{
				"start-with":matricName.value()
			}
		}
		}
	    
		var tagurl=$.tmpl.render(getMatricsURL,{
			reqdata:encodeURIComponent($.stringifyJSON(reqTagData)),
			callback:encodeURIComponent('cQuery.tmp["'+uid+'"]')
		});
		var evt=function(){
			if (!done){
				if(onlyOnce ==0){
					alert('Loading tags error, error server response. html 504');
					onlyOnce = 1;
				}
			}else{
				onlyOnce = 0;
				delete cQuery.tmp[uid];
		}
		};
		$.loader.js(tagurl,{
			async:true,
			charset:'utf-8',
			onload:evt,
			onerror:evt});
			
		newConfig.bases['%metric%']=matricName.value(); 
		
		tagPanel.css('display','');
		StagPanel.css('display','');
		
		for (var key in tag_conf){
			if (tag_conf.hasOwnProperty(key)){
				tag_conf[key].value('');
			}
		};
	////////////////////////////////////////////////////////////////////////////////////////////////
	
	
		var cc = document.getElementById('select_aggre');
		cc.options[0].selected = true;	
		var cc = document.getElementById('select_downsample');
		cc.options[0].selected = true;	
		var cd = document.getElementById('select_style');
		cd.options[0].selected = true;
		
		
		var thisendTime 	 = (new Date()).addMinutes(timeoff);
		var thisstartTime	 = thisendTime.addHours(-1);
												
		
		newConfig.bases['%chart%'] = 'line';
		newConfig.bases['statistics'] = 'sum';
		newConfig.bases['downfunc'] = 'sum';
		newConfig.bases['%interval%'] = '1m';
		newConfig.bases['%startTime%'] = thisstartTime.format(calendar.date2StringPattern);
		newConfig.bases['%endTime%'] = thisendTime.format(calendar.date2StringPattern);


		
		
		
	   $('#time_start').value(thisstartTime.format(calendar.date2StringPattern));
	   $('#time_end').value(thisendTime.format(calendar.date2StringPattern));
	   $('#time_inter').value('1m');

		matricName[0].blur();
	
	
};
function tipClick(e){
	orPanel.css('display','none'); 
	realtimePanel.css('display','none');
	if (e.target.tagName=='A'){
		matricName.value($(e.target).html());
		
		for (var key in Stag_conf){            //the tags from Stag_conf (newconfig.exps) can be changed to null or selected as the groupby tag, so  
			if (Stag_conf.hasOwnProperty(key)){			
				delete newConfig.bases['@'+key+'@']; //delete the tag	
					
			}
		}
		newConfig.groups=[];
		
		var uid='dashboard_loadTags_'+$.uid();
		
		
		var done=0;
		
		$.tmp[uid]=function(t){ 
			done=1;
			t=t['time-series-list'];  
			var i = 0;
			for(;i< t.length ;i++){
				if(t[i]['metrics-name'] == newConfig.bases['%metric%']){
					break;
					}
			}
			
			tags=t[i]['tags'];
			var divtest=$('#navigator3');			
			Stag_conf={};
			divtest.html($.tmpl.render('{{each $data}}<div style="float:left;"><label><span style="display:inline-block;width:100px;text-align:right;white-space:nowrap; word-break:keep-all;overflow:hidden; text-overflow:ellipsis; vertical-align: middle" title="${$value}">${$value}</span>: <input id="tag${$index}" name="${$value}" value="" /> </label></div> {{/each}}',tags));
		
		var index = 0;
			tags.each(function(tag){
				
				Stag_conf[""+tag+""]=$('#tag'+index);
				index++;
			});
		}
		
		var namespaceValue=namespace.value();
		if( namespaceValue=="" ) {
			namespaceValue = null;
		}
		
		var reqTagData={
		"version":1,
		"time-series-pattern":{
			"namespace":namespaceValue,
			"metrics-name":{
				"start-with":matricName.value()
			}
		}
		}
	    
		var tagurl=$.tmpl.render(getMatricsURL,{
			reqdata:encodeURIComponent($.stringifyJSON(reqTagData)),
			callback:encodeURIComponent('cQuery.tmp["'+uid+'"]')
		});
		var evt=function(){
			if (!done){
				if(onlyOnce ==0){
					alert('Loading tags error, error server response. html 504');
					onlyOnce = 1;
				}
			}else{
				onlyOnce = 0;
				delete cQuery.tmp[uid];
		}
		};
		$.loader.js(tagurl,{
			async:true,
			charset:'utf-8',
			onload:evt,
			onerror:evt});
			
		newConfig.bases['%metric%']=matricName.value(); 
		
		tagPanel.css('display','');
		StagPanel.css('display','');
		
		for (var key in tag_conf){
			if (tag_conf.hasOwnProperty(key)){
				tag_conf[key].value('');
			}
		};
	////////////////////////////////////////////////////////////////////////////////////////////////	
		var cc = document.getElementById('select_aggre');
		cc.options[0].selected = true;	
		var cc = document.getElementById('select_downsample');
		cc.options[0].selected = true;	
		var cd = document.getElementById('select_style');
		cd.options[0].selected = true;
		var thisendTime 	 = (new Date()).addMinutes(timeoff);
		var thisstartTime	 = thisendTime.addHours(-1);
												
		
		newConfig.bases['%chart%'] = 'line';
		newConfig.bases['statistics'] = 'sum';
		newConfig.bases['downfunc'] = 'sum';
		newConfig.bases['%interval%'] = '1m';
		newConfig.bases['%startTime%'] = thisstartTime.format(calendar.date2StringPattern);
		newConfig.bases['%endTime%'] = thisendTime.format(calendar.date2StringPattern);


		
		
		
	   $('#time_start').value(thisstartTime.format(calendar.date2StringPattern));
	   $('#time_end').value(thisendTime.format(calendar.date2StringPattern));
	   $('#time_inter').value('1m');

	  //showTable2();
		matricName[0].blur();
	}
};




matricNameGray.bind('focus',function(){
	matricName[0].focus();
});




function nameTags(){
	
}




function refresh(){
	// todo
}




function check_conf(){
	var reg = new RegExp('^[0-9]+[smh]$') ;

	var str = tag_conf['interval'].value();
	if(str =='')
		str = timeInterval;
	var result = reg.exec(str);
	if(result == null){	
		alert("请注意填写 格式 ，需要 符合  正整数+{smh}  的形式 ");
		return false;
	}
	
	var t = str;
	var tt = t.substr(t.length-1);
	var nu = parseInt(t.substr(0,t.length-1));
	
	
	if (nu <= 0){
		 alert("0 is not allowed");
		 return false;
	}
	switch(tt){
		case 's':  
			if(nu > 3600){
				alert("如果查询的时间间隔超过1h，我们仅提供整小时的查询服务，且输入只能以小时为单位 ");
				return false;
			}
			break;
		case 'm':  
			if(nu >=60){
				alert("如果查询的时间间隔超过1h，我们仅提供整小时的查询服务，且输入只能以小时为单位 ");
				return false;
			}
			break;
		case 'h':			
			break;
		default: 
			{
				return false;
			}
	}
	
	
	
	var calendar = new Calendar();
	
	var timest = tag_conf['startTime'].value().toString();
	var timeen = tag_conf['endTime'].value().toString();
	var thisTime = new Date();
	
	
	if (timeen == '')
		timeen = thisTime.format(calendar.date2StringPattern);
	
	//alert(timeen);
	if (timest == '')
		timest = thisTime.addMinutes(-1).format(calendar.date2StringPattern);
	//alert(timeen);
	
	if (timeen <= timest){
		alert("错误的时间输入结束时间 不应 小于 等于 开始时间 ");
		return false;
	}
	var temp =thisTime.format(calendar.date2StringPattern) ;

	var count = 0;
	for (var key in Stag_conf){            //the tags from Stag_conf (newconfig.exps) can be changed to null or selected as the groupby tag, so  
		
		if (Stag_conf.hasOwnProperty(key)){
			var val = Stag_conf[key].value();
			if(val == '*'){
				count++;
			}	
		}
	}
	if (count > 3){
		alert(" 不建议太多的聚类操作 ，数据量过大  ");
		return false;
	}
	
	return true;
}

// reset the fig

function CheckFunction(){
	
	orPanel.css('display','none');
	if(!check_conf()){
		return false;
	}
	matricName.value(newConfig.bases['%metric%']);
	real_rate = 0 ;
	if(!show){
	newConfig.groups=[];
	for (var key in Stag_conf){            //the tags from Stag_conf (newconfig.exps) can be changed to null or selected as the groupby tag, so  
		if (Stag_conf.hasOwnProperty(key)){
			var val=Stag_conf[key].value();
				if(val ==''){
					if(newConfig.bases.hasOwnProperty('@'+key+'@'))//has this tag				
					delete newConfig.bases['@'+key+'@']; //delete the tag
				}
				else{
					if(val=='*'){
					 newConfig.groups.push(key);	//add the tag in the groups
					 newConfig.bases['@'+key+'@']=''; //
					}
					else{
						var t=val.split(',');
						var le =t.length;
				//		for(var i = 0 ; i < le; i++)
				//		{
				//			t[i] = t[i].trim();	
				//		}
						newConfig.bases['@'+key+'@']=t;
						if (t.length>=1){
							newConfig.groups.push(key);
						}
					}
				}
			}
	}
		}
	var calendar = new Calendar();
	
	for (var key in tag_conf) { //the tag from tag_conf(newconfig.bases) can't be null, if no type in, set them with the default value
		if (tag_conf.hasOwnProperty(key)) {
			var val=tag_conf[key].value(); 
			if(key == 'rate') {
				var ddd=document.getElementById("is_rate").checked;
					if(ddd)
						newConfig.bases['%rate%'] = 'true';
					else
						newConfig.bases['%rate%'] = 'false';
			} 
			else if(key == 'statistics') {
					newConfig.bases['statistics'] = val;
			}
			else if(key == 'downfunc') {
				newConfig.bases['downfunc'] = val;
		}
			else{
				if(val=='') { 
					newConfig.bases['%'+key+'%'] = defaultConfig['%'+key+'%']; 
				} else {
					newConfig.bases['%'+key+'%'] = val;
				} 
				
			}
		}
	}
	
	if(newConfig.bases['%chart%'] == 'realtime'){

		var thisTime = new Date() ;
		newConfig.bases['%endTime%'] = thisTime.addMinutes(timeoff);
		var t = newConfig.bases['%interval%'];
		var tt = t.substr(t.length-1);
		var nu = parseInt(t.substr(0,t.length-1));
		if (nu == 0){
			alert("0 is not allowed");
			return false;
		}
		switch(tt){
			case 's':  
				thisTime = thisTime.addSeconds(-60*nu);
				newConfig.bases['%startTime%'] = thisTime.addMinutes(timeoff).format(calendar.date2StringPattern);
				break;
			case 'm':  
				newConfig.bases['%startTime%'] = thisTime.addMinutes(-60*nu+timeoff).format(calendar.date2StringPattern);
				break;
			case 'h':  newConfig.bases['%startTime%'] = thisTime.addHours(-60*nu); 
				break;
			default: 
				{alert("时间间隔不建议按照以小时或更大单位查询 ，如有需求请转换为分钟为单位  ");
					return false;
				}
		}
		newConfig.bases['%endTime%'] = newConfig.bases['%endTime%']; //.format(calendar.date2StringPattern)
		$('#time_start').value('');
		$('#time_end').value('');
		$('#time_inter').value(newConfig.bases['%interval%']);
		
		
	}
	
//	if(newConfig.bases['%chart%'] == 'pie'){
//		newConfig.bases['%interval%'] = '1m';
//	}
	
	if(newConfig.bases['%chart%'] == 'line'){
		//newConfig.bases['%interval%'] = '1m';
		
		$('#time_start').value(newConfig.bases['%startTime%']);
		$('#time_end').value(newConfig.bases['%endTime%']);
		var tempLeft = new Date($('#time_start').value());
		var tempRight = new Date($('#time_end').value());

		var inte= (tempRight - tempLeft)/1000;
		var intform = 0 ;
		var t = newConfig.bases['%interval%'];
		var tt = t.substr(t.length-1);
		var nu = parseInt(t.substr(0,t.length-1));
		if (nu == 0){
			alert("0 is not allowed");
			return false;
		}
		switch(tt){
			case 's':  
				if(nu >3600){
					alert("如果查询的时间间隔超过1h，我们仅提供整小时的查询服务，且输入只能以小时为单位 ");
					return false;
				}
				intfrom = nu ;
				
				break;
			case 'm':  
				if(nu >60){
					alert("如果查询的时间间隔超过1h，我们仅提供整小时的查询服务，且输入只能以小时为单位 ");
					return false;
				}
				intfrom = nu*60;
				break;
			case 'h':
				intfrom = nu*3600;				
				break;
			default: 
				{
					return false;
				}
		}
		
		if(intfrom > inte){
			alert("选定时间间隔需要不大于输入的起始时间间隔  ");
			return false;
		}
	}
	return true;
}


</script>
</body>
</html>